<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC 
	"-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.uce.suc.bkg.dao.datastatis.ILoadRatioReportDao">

	<sql id="Base_Column_List">
	plan.driving_plan_code,
	depart_time,
	arrival_time,
	business_mode,
	business.type_name as business_mode_name,
	(case when business_mode =1 then start_org_code
	when business_mode =2 then end_org_code
	end) as 'work_center_code',
	(case
	when business_mode =1 then start_org_name
	when business_mode=2 then end_org_name
	end) as 'work_center_name',
	(case when business_mode =1 then end_org_code
	when business_mode =2 then start_org_code
	end) as 'site_code',
	(CASE
	when business_mode=1 then end_org_name
	when business_mode=2 then start_org_name
	end) as 'site_name',
	plate_number,
	dirver_name as driver_name,
	plan.car_type,
	cllx.type_name as car_type_name,
	car.car_load,
	detail.actual_weight,
	(detail.actual_weight/car.car_load)*100 as 'load_ratio'
	</sql>

	<sql id="Base_Column_Where">
		<where>
			1=1
			<if test="startTimeByBegin != '' and startTimeByBegin !=null">
				and date_format(depart_time,'%Y-%m-%d') &gt;= #{startTimeByBegin}
			</if>
			<if test="startTimeByEnd != '' and startTimeByEnd != null">
				and date_format(depart_time,'%Y-%m-%d') &lt;= #{startTimeByEnd}
			</if>
			<if test="carType != null and carType != ''">
				and car_type =#{carType}
			</if>
			<if test="businessMode !=null and businessMode !=''">
				and business_mode =#{businessMode}
			</if>
			<if test="siteCode != null and siteCode !=''">
				and site_code=#{siteCode}
			</if>
			<if test="workCenterCode !=null and workCenterCode !=''">
				and work_center_code =#{workCenterCode}
			</if>
		</where>
	</sql>

	<select id="findLoadRatioReportByPage" parameterType="cn.uce.suc.bkg.vo.datastatis.LoadRatioReportVo"
		resultType="cn.uce.suc.bkg.vo.datastatis.LoadRatioReportVo">
		select * from
		(select <include refid="Base_Column_List" />
		from t_suc_bkg_dirving_plan plan
		left join (select driving_plan_code,sum(actual_weight) 'actual_weight' from
		t_suc_bkg_dirving_plan_detail
		group by driving_plan_code) detail on
		plan.driving_plan_code=detail.driving_plan_code
		left join t_suc_bkg_car car on car.car_number =plan.car_code
		left join omg_fsp_dict_data cllx on cllx.type_class_code="CAR_TYPE" and
		cllx.type_code=plan.car_type
		left join omg_fsp_dict_data business on
		business.type_class_code="BUSINESS_MODE" and
		business.type_code=plan.business_mode) loadRatioReport
		<include refid="Base_Column_Where" />
	</select>
	
	<select id="findByExport"  parameterType="cn.uce.suc.bkg.vo.datastatis.LoadRatioReportVo"
		resultType="cn.uce.suc.bkg.vo.datastatis.LoadRatioReportVo">
		select * from 
		(select <include refid="Base_Column_List" />
		from t_suc_bkg_dirving_plan plan
		left join (select driving_plan_code,sum(actual_weight) 'actual_weight' from
		t_suc_bkg_dirving_plan_detail
		group by driving_plan_code) detail on
		plan.driving_plan_code=detail.driving_plan_code
		left join t_suc_bkg_car car on car.car_number =plan.car_code
		left join omg_fsp_dict_data cllx on cllx.type_class_code="CAR_TYPE" and
		cllx.type_code=plan.car_type
		left join omg_fsp_dict_data business on
		business.type_class_code="BUSINESS_MODE" and
		business.type_code=plan.business_mode) loadRatioReport
	<include refid="Base_Column_Where" />
	</select>

</mapper>